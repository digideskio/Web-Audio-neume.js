<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>sine-storm - neume.js</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Sans+Pro">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  <link rel="stylesheet" href=//cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.css>
  <style>
    body { font-family:"Source Sans Pro",sans-serif }
    #start { margin:10px 0 }
    #canvas { width:100%;height:240px;background:black }
    #code { padding:0;margin:0;background:white;border:none }
  </style>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/vue/0.10.5/vue.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.js"></script>
  <script src="../build/neume.js"></script>
</head>
<body>
  <div class="container">
    <h1>neume.js sine-storm</h1>
    <canvas id="canvas"></canvas>
    <div id="app">
      <button id="start" v-on="click: toggle" class="btn btn-default">{{ isPlaying ? 'Stop' : 'Start' }}</button>
    </div>
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">source</h3>
      </div>
      <div class="panel-body">
        <pre class="prettyprint" id="code"></pre>
      </div>
    </div>
  </div>

  <script id="example">
  var Neume = neume(new AudioContext());

  var visualizer = null;
  var sines = [];

  var root, chord;

  function Sine($, freq, mod, amp) {
    return $("sin", { freq: $.param("freq", freq), detune: rand2(10)|0 })
    .$("sin", { freq: $.param("mod", mod), mul: $.param("amp", amp) })
    .$("out", { bus: 1 });
  }

  function FBDelay($) {
    return $("in", 1)
    .$("delay", {
      delay: $("sin", { freq: 0.1, mul: 0.00125, add: 0.125 }),
      feedback: $("sin", { freq: 0.05, mul: 0.15, add: 0.75 })
    });
  }

  var players = [];

  function start() {
    var delay = Neume.Synth(FBDelay);
    var timer = Neume.Sched(function() {
      var duration = compose();

      sines = _.range(7).map(function() {
        var freq = midicps(root + _.sample(chord) + _.sample([ 0, 12, 24, 36 ]));
        var mod = exprand(0.01, 500.0);
        var amp = exprand(0.01, 0.075);

        return Neume.Synth(Sine, freq, mod, amp)
        .fadeIn("now", 1).fadeOut("+" + duration, 1);
      });

      return { next: "+" + duration };
    });

    players = [ delay, timer, visualizer ];

    players.forEach(function(player) {
      player.start();
    });
  }

  function stop() {
    players.forEach(function(player) {
      player.stop();
    });
  }

  function compose() {
    if (Math.random() < 0.75) {
      root = 36 + _.sample([ 0, 0, 0, 5, 7, 7 ]);
      chord = [ 0, 4, 5, 7, 11, 12 ];
    } else {
      root = 36 + _.sample([ 2, 4, 4, 6, 6, 6 ]);
      chord = [ 0, 3, 5, 7, 11, 12 ];
    }

    return _.sample([ 2.5, 5, 10, 15, 20, 25 ]);
  }

  function rand2(size) {
    return (Math.random() * 2 - 1) * size;
  }

  function exprand(min, max) {
    return linexp(Math.random(), 0, 1, min, max);
  }

  function midicps(midi) {
    return 440 * Math.pow(2, (midi - 69) / 12);
  }

  function linexp(value, inMin, inMax, outMin, outMax) {
    return Math.pow(outMax / outMin, (value - inMin) / (inMax - inMin)) * outMin;
  }
  </script>

  <script>
  $(function() {
    "use strict";

    var WaveVisualizer = (function() {
      var X = 0, Y = 1;

      function WaveVisualizer(analyser, spec) {
        this.width  = spec.width;
        this.height = spec.height;

        this._state = "init";
        this._canvas = spec.canvas;
        this._canvas.width  = this.width;
        this._canvas.height = this.height;
        this._context = this._canvas.getContext("2d");
        this._context.fillStyle   = "rgba(0, 0, 0, 0.4)";
        this._context.strokeStyle = "#c0c0c0";
        this._context.lineWidth = 0.5;
        this._index = 0;

        this.fps = 20;
      }

      WaveVisualizer.prototype.start = function() {
        if (this._state !== "start") {
          this._state = "start";
          this._prevT = Date.now();
          requestAnimationFrame(this.render.bind(this));
        }
        return this;
      };

      WaveVisualizer.prototype.stop = function() {
        if (this._state === "start") {
          this._state = "stop";
        }
        return this;
      };

      WaveVisualizer.prototype.render = function() {
        var t = Date.now();
        var dt = (t - this._prevT) * 0.001;

        if (1 / this.fps < dt) {
          this._prevT = t;
          this._render(t);
        }

        if (this._state === "start") {
          requestAnimationFrame(this.render.bind(this));
        }
      };

      WaveVisualizer.prototype._render = function() {
        var sine = sines[this._index++ % sines.length];

        if (!sine) {
          return;
        }

        var freq = sine.freq.value * 0.0125;
        var mod = sine.mod.value * 20;
        var amp = sine.amp.value * 10;

        var context = this._context;

        var w = this.width;
        var h = this.height;

        freq = Math.round(freq) * 2 * Math.PI;
        mod = Math.round(mod) * 2 * Math.PI;
        amp *= this._index % 2 ? -1 : +1;

        context.fillRect(0, 0, w, h);

        context.beginPath();
        context.moveTo(0, h * 0.5);
        for (var i = 1; i < w; i += 2) {
          var p = i / w;
          var v = Math.sin(freq * p) * Math.sin(mod * p) * amp;
          var x = Math.round(p * w);
          var y = Math.round(h * (1 - v) * 0.5);

          context.lineTo(x, y);
        }
        context.lineTo(w, h * 0.5);
        context.stroke();
      };

      return WaveVisualizer;
    })();

    var canvas = document.getElementById("canvas");

    visualizer = new WaveVisualizer(Neume.analyser, {
      canvas: canvas, width: $(canvas).width(), height: 240
    });

    var vue = new Vue({
      el: "#app",
      data: {
        isPlaying: false
      },
      methods: {
        toggle: function() {
          Neume.reset();
          this.isPlaying = !this.isPlaying;
          if (this.isPlaying) {
            start(this.$data.score);
          } else {
            stop();
          }
        }
      }
    });

    $("#code").text($("#example").text());
    prettyPrint();
  });
  </script>
</body>
</html>
