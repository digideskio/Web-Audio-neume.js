<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>8bit-sequencer - neume.js</title>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  <link rel="stylesheet" href=//cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.css>
  <style>
    .pattern {
      font-family:"Courier New",monospace;margin-top:10px;
      user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;
    }
    .pattern li:nth-child(4n+2) { margin-left: 6px }
    .pattern li:nth-child(16n+2) { margin-left: 10px }
    #start { margin: 10px 0 }
    #canvas { width:100%;height:240px;background:black }
    #code { padding:0;margin:0;background:white;border:none }
  </style>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/vue/0.10.5/vue.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.js"></script>
  <script src="//mohayonao.github.io/gretro/build/gretro.min.js"></script>
  <script src="../build/neume.js"></script>
</head>
<body>
  <div class="container">
    <h1>neume.js 8bit-sequencer</h1>
    <canvas id="canvas"></canvas>
    <div id="app">
      <div class="pattern">
        <ul class="list-inline" v-repeat="score">
          <li style="width:40px">{{ $root.$data.caption[$index] }}</li>
          <li v-repeat="$data" v-on="click: $data.checked = 1 - $data.checked">{{ $data.checked ? 'O' : '-' }}</li>
        </ul>
      </div>
      <button id="start" v-on="click: toggle" class="btn btn-default">{{ isPlaying ? 'Stop' : 'Start' }}</button>
    </div>
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 class="panel-title">source</h3>
      </div>
      <div class="panel-body">
        <pre class="prettyprint" id="code"></pre>
      </div>
    </div>
  </div>

  <script id="example">
  var Neume = neume(new AudioContext());

  var visualizer = null; // gretro: http://mohayonao.github.io/gretro/

  // create a PeriodicWave from the array
  var famiconTriangle = Neume.Buffer.from([
    +0.000, +0.125, +0.250, +0.375, +0.500, +0.625, +0.750, +0.875,
    +0.875, +0.750, +0.625, +0.500, +0.375, +0.250, +0.125, +0.000,
    -0.125, -0.250, -0.375, -0.500, -0.625, -0.750, -0.875, -1.000,
    -1.000, -0.875, -0.750, -0.625, -0.500, -0.375, -0.250, -0.125 ]).resample(4096, false).toPeriodicWave();

  // define synth
  function Seq1($, freq) {
    var out;

    out = [
      $(famiconTriangle, { freq: freq * 0.99 }),
      $(famiconTriangle, { freq: freq * 1.01 }),
    ];
    out = $("xline", { start: 0.05, dur: "8n" }, out).on("end", function(e) {
      this.stop(e.playbackTime);
    });

    return out;
  }

  function Seq2($, freq) {
    var out;

    out = $("tri", { freq: $("xline", { start: freq * 2, end: freq * 0.5, dur: "4nd" }) });
    out = $("sin", { freq: freq * 7 }, out);

    out = $("xline", { start: 0.05, dur: "4nd" }, out).on("end", function(e) {
      this.stop(e.playbackTime);
    });

    out = [ out, $("delay", { delay: "16nt", feedback: 0.5 }, out.mul(0.25)) ];
    out = $("+", out);

    return out;
  }

  function HiHat($, amp) {
    var out;

    out = $("white");
    out = $("hpf", { freq: 8000, Q: 25 }, out);
    out = $("xline", { start: amp * 0.005, dur: 0.050 }, out).on("end", function(e) {
      this.stop(e.playbackTime);
    });

    return out;
  }

  function Snare($, dur) {
    var out;

    out = $("pink");
    out = $("lpf", { freq: 2400, Q: 10 }, out);
    out = $("xline", { start: 0.1, dur: dur * 0.1 }, out).on("end", function(e) {
      this.stop(e.playbackTime);
    });

    return out;
  }

  function Bass($) {
    var out;

    out = [
      $("clip", { mul: 0.4 }, $("tri", { freq: 80, mul: 2 })),
      $("pink", { mul: 0.05 }),
    ];
    out = $("lpf", { freq: 180, Q: 4 }, out);
    out = $("xline", { start: 0.4, dur: 0.100 }, out).on("end", function(e) {
      this.stop(e.playbackTime);
    });

    return out;
  }

  var instruments = [
    { func: Seq1 , arg: [ 880, 440, 1760, 220, 1760, 660, 1760, 660 ] },
    { func: Seq2 , arg: [ 880, 440, 1760, 220, 1760, 660, 1760, 660 ] },
    { func: HiHat, arg: [ 4, 1, 2, 1 ] },
    { func: Snare, arg: [ 8, 2, 6, 4 ] },
    { func: Bass , arg: [] },
  ];

  var players = [];

  function start(score) {
    Neume.context.reset();

    var timer = Neume.Interval("16n", function(e) {
      var index = e.count % 32;

      instruments.forEach(function(instrument, i) {
        if (score[i][index].checked) {
          var arg = wrapAt(instrument.arg, index);

          Neume.Synth(instrument.func, arg).start(e.playbackTime);
        }
      });
    });

    players = [ timer, visualizer ];

    players.forEach(function(player) {
      player.start();
    });
  }

  function stop() {
    players.forEach(function(player) {
      player.stop();
    });
  }

  function wrapAt(list, index) {
    return list[index % list.length];
  }
  </script>

  <script>
  $(function() {
    "use strict";
    var WaveVisualizer = (function() {
      function WaveVisualizer(analyser, spec) {
        this.width  = spec.width;
        this.height = spec.height;

        this._analyser = analyser
        this._analyser.fftSize = 512;
        this._state = "init";
        this._timeData = new Uint8Array(analyser.frequencyBinCount);
        this._canvas   = spec.canvas;
        this._canvas.width  = spec.width;
        this._canvas.height = spec.height;
        this._context = this._canvas.getContext("2d");
        this._context.fillStyle = "rgb(0, 0, 32)";
        this._context.fillRect(0, 0, spec.width, spec.height);
        this._context.fillStyle = "rgba(0, 0, 32, 0.075)";
        this._drawX = 0;
      }

      WaveVisualizer.prototype.start = function() {
        if (this._state !== "start") {
          this._state = "start";
          requestAnimationFrame(this.render.bind(this));
        }
        return this;
      };

      WaveVisualizer.prototype.stop = function() {
        if (this._state === "start") {
          this._state = "stop";
        }
        return this;
      };

      WaveVisualizer.prototype.render = function(t) {
        this._analyser.getByteTimeDomainData(this._timeData);
        this._context.fillRect(0, 0, this.width, this.height);

        var imageData = this._context.getImageData(0, 0, this.width, this.height);
        var grCanvas = new gretro.Canvas(this.width, this.height, imageData.data);

        this._render(t, grCanvas);

        this._context.putImageData(imageData, 0, 0);

        if (this._state === "start") {
          requestAnimationFrame(this.render.bind(this));
        }
      };

      WaveVisualizer.prototype._render = function(t, grCanvas) {
        var data = this._timeData;
        var tile = ((t * 0.005)|0) % 16;

        grCanvas.noStroke().fill([ 4, 13, tile ]);

        for (var i = 0, imax = data.length; i < imax; i += 4) {
          var x = this._drawX;
          var y = this.height * 0.5;
          var w = 8;
          var h = ((data[i] / 256) - 0.5) * 8 * this.height;

          grCanvas.rect(x, y, w, -h);

          this._drawX += w;
          if (this.width <= this._drawX) {
            this._drawX = 0;
          }
        }
      };

      return WaveVisualizer;
    })();

    var canvas = document.getElementById("canvas");

    visualizer = new WaveVisualizer(Neume.analyser, {
      canvas: canvas, width: $(canvas).width(), height: 240
    });

    var vue = new Vue({
      el: "#app",
      data: {
        isPlaying: false,
        caption: [ "Seq1", "Seq2", "HH", "SD", "BD" ],
        score: _.map([
          [ 1, 1, 1, 1,  1, 1, 1, 1,  1, 1, 1, 1,  1, 1, 1, 1,
            0, 1, 0, 0,  1, 0, 1, 0,  0, 0, 1, 0,  1, 0, 1, 1, ],
          [ 0, 0, 0, 0,  0, 0, 0, 0,  0, 0, 0, 0,  0, 0, 0, 0,
            1, 0, 0, 0,  0, 0, 0, 0,  0, 0, 0, 0,  0, 0, 0, 0, ],
          [ 1, 1, 1, 1,  1, 1, 1, 1,  1, 0, 1, 0,  1, 1, 1, 0,
            1, 1, 1, 1,  1, 1, 1, 1,  1, 0, 1, 0,  1, 1, 1, 0, ],
          [ 0, 0, 0, 0,  1, 0, 0, 1,  0, 0, 0, 0,  1, 0, 0, 0,
            0, 0, 0, 0,  1, 0, 0, 1,  0, 0, 1, 0,  0, 0, 1, 0, ],
          [ 1, 0, 0, 0,  0, 0, 1, 0,  0, 0, 0, 1,  0, 0, 0, 0,
            1, 0, 0, 0,  0, 0, 1, 0,  0, 1, 0, 0,  1, 0, 0, 0, ],
        ], function(pattern) {
          return _.extend({}, _.map(pattern, function(checked) {
            return { checked: checked };
          }));
        })
      },
      methods: {
        toggle: function() {
          this.isPlaying = !this.isPlaying;
          if (this.isPlaying) {
            start(this.$data.score);
          } else {
            stop();
          }
        }
      }
    });

    $("#code").text($("#example").text());
    prettyPrint();
  });
  </script>
</body>
</html>
